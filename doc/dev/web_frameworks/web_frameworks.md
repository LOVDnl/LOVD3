# Exploring web frameworks for LOVD

Version 0.2 (2016-03-24)

## Introduction

For the development of LOVD, a web framework may improve development by
providing common features out-of-the-box. It may also speed up 
development and maintenance of by providing structure, tools and hooks
that help in building new features. This document aims to give an
overview of the current offer of PHP web frameworks, and their
potential added value for long-term LOVD development.

Features potentially provided by a web framework:

**Object-relational mapping (ORM)**

* Mapping of PHP objects to database. Making basic access to the 
  database easy by just defining classes in PHP and letting the
  mapper translate method calls to SQL. (E.g. calling 
  `Users.get(10)` instead of 
  `$_DB->query('SELECT * FROM users WHERE id = 10')`)

**Routing**

* Mapping urls/requests to functions/objects. E.g. lets you write 
  `Route::get($uri, $callback)` instead of manually parsing `$_GET`
  and its arguments in each php file facing the web server.

**Model-view-controller (MVC)**

* Design pattern to separate interface functionality from application
  logic. Widely used on all kinds of platforms (see [MVC]).

**Template engine**

* Making it easy to separate HTML/Javascript/CSS from PHP code (i.e.
  in separate files).

**Authentication**

* Authentication handling without manually getting/setting cookies,
  session variables or generating authentication tokens.

**Logging**

* Logging to database, file, web page. With simple configuration and
  automatic cleanup.

**Caching**

* Caching of objects (e.g. HTML generated by the template engine) 
  with support for multiple backends (e.g. Memcached or Redis).

**Form building/validation (Forms)**

* Generating forms and do automatic validation through defining 
  classes rather than manually defining form fields in HTML and 
  capturing their values in the next request.

**Web server**

* Providing a built-in web server, instead of having to install and
  configure Apache or nginx.


Then there are non-feature reasons to use or not use a web framework.
Here a few possible upsides and downsides of using a web framework.

Upsides:

* Code is used and tested in a larger community, making it generally
  less prone to bugs.
* Provide structure (e.g. tried and tested design patterns) that allows
  developers to focus on application-level code instead of low-level
  details.
* A framework's structure is expected to be common outside the LOVD
  development team, making it easier for future developers to learn.

Downsides:

* An extra threshold of learning the framework before one can be 
  productive using it.
* Sometimes the framework's structure may work against the developer in
  developing new features. Forcing a tradeoff between conforming to the
  structure and design choices.
* Development of a framework may stop or the surrounding community may
  decline, making the application unmaintainable in the long run.



## Requirements

Adopting a framework will be a tradeoff in speed of development,
flexibility, stability and performance. However, certain requirements
of a framework are non-negotiable as they are (potentially) very
destructive.

General requirements:

* The framework should be under active development. (I.e. are bugs
  fixed and are developers actively involved).
* The framework should have a considerable user base and support
  platform. (E.g. if we have a question or issue, are there developers
  or is there a community where we can turn to)

LOVD-specific requirements:

* If the framework supplies an ORM, it should not be too difficult to
  bypass it and implement performance-sensitive queries directly in 
  SQL.
* If the framework supplies an ORM, it must allow in some fashion the
  addition of custom columns to tables of core entities (e.g. genes,
  phenotypes, etc.).
* Complexity of installation should not create a threshold for users to
  install their own copy of LOVD.


## Candidates


### Long list

Long list of PHP frameworks commonly used. These were found by browsing
wikipedia, searches in Google, Stackoverflow and Github. Type is a 
classification for the framework's feature set, based on 
[TE benchmarks], which has 3 categories in ascending order of feature 
completeness: Platform (Plt), Micro framework (Micro) and Full-Stack
framework (FS).

| Name         | Started | Type     | URL                            |
| -------------| ------- | -------- | ------------------------------ |
| CakePHP      | 2005    | FS       | http://cakephp.org             |
| CodeIgniter  | 2006    | FS       | http://www.codeigniter.com     |
| Cygnite      | 2013    | FS       | http://cygniteframework.com    |
| Drupal       | 2001    | FS       | https://www.drupal.org         |
| eZ Publish   | 2009?   | FS       | http://ez.no                   |
| Fat-Free     | 2012    | Micro    | http://fatfreeframework.com    |
| FuelPHP      | 2011    | Micro    | http://fuelphp.com             |
| Horde        | 1998    | FS       | http://www.horde.org           |
| Joomla!      | 2005    | FS       | http://www.joomla.org          |
| Kohana       | 2007    | FS       | http://kohanaframework.org     |
| Laravel      | 2011    | FS/Micro | http://laravel.com             |
| Lithium      | 2009    | FS       | http://li3.me                  |
| MODX         | 2004    | FS       | http://modx.com                |
| Nette        | 2008    | FS       | http://nette.org/en            |
| Phalcon      | 2012    | FS/Micro | http://phalconphp.com/en       |
| PRADO        | 2004    | FS       | http://www.pradoframework.net  |
| Qcodo        | 2005    | FS       | http://www.qcodo.com           |
| Silex        | 2010    | FS/Micro | http://silex.sensiolabs.org    |
| SilverStripe | 2008?   | FS       | http://silverstripe.org        |
| Slim         | 2011    | Micro    | http://www.slimframework.com   |
| Symfony      | 2005    | FS       | https://symfony.com            |
| TYPO3        | 1998    | FS       | http://typo3.org               |
| WordPress    | 2003    | FS       | https://wordpress.org          |
| Xaraya       | 2012    | FS       | http://www.xaraya.info         |
| XOOPS        | 2006    | FS       | http://www.xoops.org           |
| Yii 2        | 2013    | FS       | http://www.yiiframework.com    |
| Zend         | 2006    | FS       | http://framework.zend.com      |


The table b|elow sho |ws stats  |for some of the frameworks in the long 
list. The stats include an *HFscore*, which is a popularity score from
the [HotFrameworks] rankings. *TEscore*, which is the number of 
responses returned in the [TE benchmarks] of techempower.com. Finally,
*Notejam* denotes whether the framework was included in the example
applications of the [notejam] project.

Please note that these statistics are not always conclusive. The 
HFscore measures popularity, which may indicate development activity 
and size of the userbase, but not necessarily. Also, the Drupal and
Slim frameworks were not included in any of the stats, but are more
popular than other frameworks on the list (e.g. on stackoverflow).
The TEscore is a performance measure, but not necessarily the type of
performance relevant for LOVD (i.e. we may be more interested in how
fast a complex request is processed rather than how many simple
requests per minute).

Still, these stats are used to prioritize frameworks on the shortlist.


| Name         | HFscore |  TEscore | Notejam |
| ------------ | ------- | -------- | ------- |
| Laravel      |      87 |    2,056 |     yes |
| CodeIgniter  |      85 |   12,950 |      no |
| Symfony      |      85 |      707 |     yes |
| CakePHP      |      79 |      n/a |     yes |
| Zend         |      78 |      n/a |      no |
| Yii          |      76 |     fail |     yes |
| Phalcon      |      68 |   38,966 |      no |
| Kohana       |      63 |    7,428 |      no |
| Fat-Free     |      55 |     fail |      no |
| SilverStripe |      54 |      n/a |      no |
| Drupal       |     n/a |      n/a |      no |
| Slim         |     n/a |      n/a |      no |


### Short list

More details on features and flavours of

* Laravel
* Phalcon
* Slim

#### Laravel (Micro: Laravel Lumen)

* Initiated as a more advanced alternative to the CodeIgniter 
  framework.
* Installation requirements
    * PHP >= 5.5.9
    * OpenSSL PHP Extension
    * PDO PHP Extension
    * Mbstring PHP Extension
    * Tokenizer PHP Extension
* Features
    * ORM (yes: *Eloquent*)
    * Routing (yes)
    * MVC (yes)
    * Template engine (yes: *Blade*)
    * Authentication (yes)
    * Logging (yes)
    * Caching (yes: *Memcached* and *Redis*)
    * Forms (yes: *Form request*)
    * Web server (no)
* Miscellaneous
    * Laravel European conference this year in Amsterdam.

##### Laravel 4.2 Notejam examples

Source: https://github.com/komarserjio/notejam/tree/master/laravel/notejam

###### Routing

```PHP
<?php
# user related routes (anonymous)
Route::get(
    'signup',
    array('as' => 'signup', 'uses' => 'UserController@signup')
);
Route::post(
    'signup',
    array('as' => 'user.store', 'uses' => 'UserController@store')
);
?>
```

###### ORM

```PHP
<?php
use Illuminate\Auth\UserInterface;
class User extends Eloquent implements UserInterface {
    /**
     * The database table used by the model.
     *
     * @var string
     */
    protected $table = 'users';
    /**
     * The attributes excluded from the model's JSON form.
     *
     * @var array
     */
    protected $hidden = array('password');
    protected $fillable = array('email', 'password');
    /**
     * Get the unique identifier for the user.
     *
     * @return mixed
     */
    public function getAuthIdentifier()
    {
        return $this->getKey();
    }
    /**
     * Get the password for the user.
     *
     * @return string
     */
    public function getAuthPassword()
    {
        return $this->password;
    }
?>
```


###### MVC and Template engine

View for signup form in Blade:

```PHP
<?php
@extends('layout')

@section('page_title')
Sign Up
@stop

@section('content')
    {{ Form::open(array('class' => 'offset-by-six')) }}

    {{ Form::label('email', 'E-mail') . Form::text('email', Input::old('email')) }}
    @include('partials.error', array('error' => $errors->first('email')))
    {{ Form::label('password', 'Password') . Form::password('password') }}
    @include('partials.error', array('error' => $errors->first('password')))
    {{ Form::label('password_confirmation', 'Confirm password') . Form::password('password_confirmation') }}
    @include('partials.error', array('error' => $errors->first('password_confirmation')))

    {{ Form::submit('Sign Up') }} or <a href="{{ URL::route('signin'); }}">Sign in</a>

    {{ Form::close() }}

@stop
?>
```

Controller for user signup:

```PHP
<?php
class UserController extends BaseController {
    public function signup()
    {
        return View::make('user/signup');
    }
    public function store()
    {
        $validation = Validator::make(
            Input::all(),
            array(
                'email' => 'required|email|unique:users',
                'password' => 'required|min:6|confirmed',
                'password_confirmation' => 'required|min:6',
            )
        );
        if ($validation->fails())
        {
            return Redirect::route('signup')->withErrors($validation);
        }
        $user = User::create(
            array(
                'email'  => Input::get('email'),
                'password' => Hash::make(Input::get('password'))
            )
        );
        return Redirect::route('signin')
            ->with('success', 'Account is created. Now you can sign in.');
    }
?>
```



#### Phalcon

* Highest performance of all PHP frameworks
* Provided as a PHP extension written in C

NB: not investigated any further, as it requires git and C-compilation 
to install. This does not fit with LOVD's requirement for ease of
installation.


#### Slim

* Very lightweight, best performance next to Phalcon.
* Developed by Josh Lockhart (known for phptherightway.com and 
  O'Reilly's book "Modern PHP")
* Follows PSR-7
* Features
    * Routing (yes)
    * Templates (optional: slim/php-view or Twig)
    * Dependency injection (yes)
* Dev team: 142 contributors, 1251 github forks
* Activity past month: 8 pull requests merged, 34 issues closed, 6 opened.
* ~1200 questions on stackoverflow.com

##### Slim3 examples (from tutorial)

Routing

```PHP
<?php
$app->get('/hello/{name}', function (Request $request, Response $response) {
    $name = $request->getAttribute('name');
    $response->getBody()->write("Hello, $name");
    $this->logger->addInfo("Said hello to $name");

    return $response;
});

$app->get('/genes/{GENE_ID}', function (Request $req, Response $res) {
    $gene_ID = $req->getAttribute('GENE_ID');
    $this->logger->addInfo("viewing gene $gene_ID");

    $query = "SELECT id, name, chromosome FROM lovd_v3_genes WHERE id='$gene_ID'";
    $gene_obj = $this->db->query($query)->fetch();

    $res = $this->view->render($res, "gene.html", ["gene" => $gene_obj]);
    return $res;
});
?>
```

Dependency injection

```PHP
<?php
$container = $app->getContainer();

// Add logger
$container['logger'] = function($c) {
    $logger = new \Monolog\Logger('my_logger');
    $file_handler = new \Monolog\Handler\StreamHandler("../logs/app.log");
    $logger->pushHandler($file_handler);
    return $logger;
};

// Add PHP template renderer
$container['view'] = new \Slim\Views\PhpRenderer("../templates/");
?>
```


### Separate libraries

An intermediate option between LOVD's current platform (raw php) and a
full-fledged web framework, is to use separate libraries for specific
features. Using libraries nowadays is easy with dependency management
by composer (although it has to be made runnable within lumc) Potential
upsides of using such an approach:

* More flexible than a framework (picking best tool per feature).
* Less relient on framework's community.

Potential downsides for this approach:

* More risk that at least one of the used libraries will become 
  deprecated. (more and smaller communities)
* Separate libraries may provide less program structure, or each 
  employs a different structure.

#### Popular libraries per feature

* ORM
    * [ADOdb](http://adodb.org)
        * Custom database abstraction layer (similar to PDO, but more DBs).
        * Uses ActiveRecord pattern.
    * [Doctrine](http://www.doctrine-project.org)
        * Based on Hibernate, comes with custom query language DQL.
    * [Eloquent](https://laravel.com/docs/5.0/eloquent)
        * Laravel's ORM
        * ActiveRecord
    * [Propel](http://propelorm.org/)
        * XML-based config
* Logging
    * [Monolog](https://packagist.org/packages/monolog/monolog)
        * PSR-3 compatible
* Events/hooks
    * [Symfony EventDispatcher](https://packagist.org/packages/symfony/event-dispatcher)
        * Component of Symfony framework
        * php5.5.9+
* Template engines
    * [php-text-template](https://packagist.org/packages/phpunit/php-text-template)
    * [Twig](https://packagist.org/packages/twig/twig)
* HTML tables (viewlists)
    * [DataTables](http://datatables.net) (jQuery plugin)
    * [Dynatable](https://www.dynatable.com)



## References

[catonmat blog]:    http://www.catonmat.net/blog/frameworks-dont-make-sense/
[HotFrameworks]:    http://hotframeworks.com/languages/php
[TE benchmarks]:    https://www.techempower.com/benchmarks
[MVC]:              https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller
[notejam]:          https://github.com/komarserjio/notejam
[packagist]:        https://packagist.org/